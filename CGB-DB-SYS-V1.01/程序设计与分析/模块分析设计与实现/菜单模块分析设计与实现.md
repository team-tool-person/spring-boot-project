# 1. 菜单模块分析 #

> 菜单管理又称为资源管理，是系统资源对外的表现形式。

菜单就是数据的类名,如`手机/电脑/主机`这就是一个一级菜单,可以细分为三个二级菜单

## 1.1 数据库设计 ##

### 1.1.1 数据库表设计 ###

| 字段名       | 类型     | 约束    | 说明                           |
| ------------ | -------- | ------- | ------------------------------ |
| id           | int      | primary | 菜单主键                       |
| name         | varchar  |         | 菜单名称                       |
| url          | varchar  |         | 资源URL                        |
| type         | int      |         | 类型<br />1: 菜单<br />2: 按钮 |
| sort         | int      |         | 排序                           |
| note         | varchar  |         | 备注                           |
| parentId     | int      |         | 父辈菜单id                     |
| permission   | varchar  |         | 授权,如                        |
| createdTime  | datetime |         | 创建时间                       |
| modifiedTime | datetime |         | 修改时间                       |
| createdUser  | varchar  |         | 创建用户                       |
| modifiedUser | varchar  |         | 修改用户                       |

### 1.1.2 数据关系分析 ###

菜单管理又称为资源管理，是系统资源对外的表现形式

所以不同的角色之间所拥有的菜单也不相同

在数据库中菜单和角表示多对多的关系,一个角色可以查看多个菜单,一个菜单可以被多个角色查看

<img src="https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/image5-2023-10-1115:30:00.png" alt="image5-2023-10-1115:30:00.png" style="zoom:67%;" />

需要一张表来描述两个表之间的关系

<img src="https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/image8-2023-10-1115:36:38.png" alt="image8-2023-10-1115:36:38.png" style="zoom:67%;" />

在删除表时应该进行阻止,先将主表中关系进行删除,在删除从表中的内容

## 1.2 创建主表 ##

| 字段名  | 类型 | 约束    | 说明   |
| ------- | ---- | ------- | ------ |
| id      | int  | primary | 主键   |
| role_id | int  |         | 角色id |
| menu    | int  |         | 菜单id |

# 2. 原型说明 #

菜单浏览页面

<img src="https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/image6-2023-10-1115:56:25.png" alt="image6-2023-10-1115:56:25.png" style="zoom:67%;" />

菜单添加页面

<img src="https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/image19-2023-10-1116:03:44.png" alt="image19-2023-10-1116:03:44.png" style="zoom:67%;" />

在编辑上级菜单时会有弹窗加载页面

<img src="https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/image17-2023-10-1116:04:59.png" alt="image17-2023-10-1116:04:59.png" style="zoom:67%;" />

# 3. API架构分析 #

![image21-2023-10-1209:37:02.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/image21-2023-10-1209:37:02.png)

+ 数据层:

  在数据层中有两个`dao`分别控制这两张表,菜单表和菜单角色关系表

# 4. 菜单页面呈现 #

## 4.1 菜单页面呈现功能分析 ##

页面呈现时序图

<img src="https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/image12-2023-10-1209:44:15.png" alt="image12-2023-10-1209:44:15.png" style="zoom:67%;" />

## 4.2 菜单页面呈现实现 ##

服务器端

```java
/**
 * Menu菜单数据展示页面,用来展示数据信息和数据操作
 */
@RequestMapping("menu/menu_list")
public String doMenusUI() {
	return "sys/menu_list";
}
```

客户端

```js
//单击按钮加载页面
$(function(){
     doLoadUI("load-menu-id","menu/menu_list");
});
```

### ###REST风格URL映射 ###

[什么是REST风格? 什么是RESTFUL?（一篇全读懂）_rest风格和restful风格-CSDN博客](https://blog.csdn.net/SeniorShen/article/details/111591122)

我们这里可以写一个万能也页面加载方法

```java
/**
 * 页面加载的通用方法
 * 
 * @param moduleUI 模块页面名称
 */
@RequestMapping("/{module}/{moduleUI}")
public String ModuleUI(@PathVariable String moduleUI) {
	return "sys/"+moduleUI;
}
```

这个方法的优先级和低(有较强的通用性),如果有指定地址型的方法,会优先执行指定地址值的方法

> REST风格的URL映射
> REST是一种软件架构编码风格,在这种风格下的url定义,可以使用变量的方法让url更加简单
>
> 在方法参数中需要url中的{变量}值时,使用注解`@pathVariable`进行获取,并且要求被修饰的变量名,和{变量}表达式中的变量名相同

# 5. 菜单查询功能 #

## 5.1 菜单查询功能分析与设计 ##

### 5.1.1 查询数据分析 ###

每个菜单都有一个属性:`parentId`父菜单

我们查询数据时,要形成自关联,查询的信息要包含符菜单的信息

![image14-2023-10-1213:52:27.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/image14-2023-10-1213:52:27.png)

所以要是用关联查询`join`或者子查询

### 5.1.2 数据架构分析 ###

![image20-2023-10-1210:56:49.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/image20-2023-10-1210:56:49.png)

+ 查询到的数据封装到Map中

  一个map对应一行的数据,其中key表示字段名,value为其中的值

  <font color='red'>一般情况下,使用map封装我们的对象是不被允许的要使用pojo对象来封装查询的到信息</font>

  使用map对象的优点:开发效率高,可以做到快速去重,可一确定关联关系

  缺点:没有类型泛型,无法约束

  因为我们查询数据不涉及到分页,所以我们查询到的数据直接放置到`view object`JSONResult对象中

### 5.1.3 时序图分析 ###

![image18-2023-10-1211:13:45.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/image18-2023-10-1211:13:45.png)

+ 我们先查询数据,查询到的对象封装到map中
+ 将`List<Map>`直接放置到`View Object`JsonResult类中

## 5.2 菜单查询功能实现 ##

### 5.2.1 持久层实现 ###

#### mapper 接口实现 ####

```java
@Mapper
public interface MenusDao {  
    List<Map<String,Object>> findObjects();
}
```

#### SQL语句设计 ####

使用关联查询来实现:

[SQL关联查询_sql关联关系-CSDN博客](https://blog.csdn.net/s1f56s/article/details/91383814)

```xml
<select id="findObjects" resultType="Map">
	select c.*,p.name parentName from sys_menus c left join sys_menus p on c.parentId=p.id
</select>
```

使用子查询来实现:

[SQL 子查询_w3cschool](https://www.w3cschool.cn/sql/zjdc1oz3.html)

```xml
<select id="findObjects" resultType="Map">
	select c.*,(select p.name from sys_menus p where c.parentId=p.id) parentName from sys_menus c
</select>
```

### 5.2.2 业务层实现 ###

```java
package com.cy.pj.sys.service;
public interface MenusService {
    List<Map<String,Object>> findObjects ();
}
```

```java
public List<Map<String, Object>> findObjects() {    
	List<Map<String,Object>> maps =  menusDao.findObjects();
	return maps;
}
```

### 5.2.3 控制层实现 ###

将查询到的数据封装到vo对象JsonResult中,以JSON格式传递到前端

```java
@RequestMapping("doFindObjects")
public JsonResult findPageObjects(){
	List<Map<String,Object>> maps = service.findObjects();     
	return new JsonResult(maps);
}
```

#### ###@ResponseBody,@RestController ####

**使用@ResponseBody直接修饰Controller:**

我们在之前创建一个`PageController`用来对页面的进行返回

所以其他模块中的Controller其实都是返回的JSON数据

可以直接使用注解@ResponseBody进行修饰Controller类型

实现Controller所有的方法都以JSON格式数据来将数据传递到前端

[@ResponseBody详解-CSDN博客](https://blog.csdn.net/originations/article/details/89492884)

**使用@RestController:**

注解@RestController相当于注解@Controller+注解@ResponseBody

> - @Controller 一般应用在有返回界面的应用场景下.
>
>   例如，管理后台使用了 thymeleaf 作为模板开发，需要从后台直接返回 Model 对象到前台，那么这时候就需要使用 @Controller 来注解。
>
> - @RestController 如果只是接口，那么就用 RestController 来注解.
>
>   例如前端页面全部使用了 Html、Jquery来开发，通过 Ajax 请求服务端接口，那么接口就使用 @RestController 统一注解。

[Spring Boot Web 开发@Controller @RestController 使用教程 - fishpro - 博客园 (cnblogs.com)](https://www.cnblogs.com/fishpro/p/spring-boot-study-restcontroller.html)

### 5.2.4 客户端实现 ###

+ 创建展示数据表格

  在这个表格中没有具体的列,创建列的过程有treegrid来实现

  ```html
  <table id="menuTable" class="table table-hover">
  	<thead>
  		<tr>
  			<th data-field="selectItem" data-checkbox="true"></th>
  		</tr>
  	</thead>       
  </table>
  ```

   在这里创建了一列,单选框

+ 定义列配置

  ```js
  /**
   * 初始化表格的列
   */
  var columns = [
  {
  	field : 'selectItem',
  	radio : true
  },
  {
  	title : '菜单ID',
  	field : 'id',
  	align : 'center',
  	valign : 'middle',
  	width : '80px'
  },
  {
  	title : '菜单名称',
  	field : 'name',
  	align : 'center',
  	valign : 'middle',
  	width : '130px'
  },
  {
  	title : '上级菜单',
  	field : 'parentName',
  	align : 'center',
  	valign : 'middle',
  	sortable : true,
  	width : '100px'
  },
  {
  	title : '类型',
  	field : 'type',
  	align : 'center',
  	valign : 'middle',
  	width : '70px',
  	formatter : function(item, index) {
  		if (item.type == 1) {
  			return '<span class="label label-success">菜单</span>';
  		}
  		if (item.type == 2) {
  			return '<span class="label label-warning">按钮</span>';
  		}
  	}
  }, 
  {
  	title : '排序号',
  	field : 'sort',
  	align : 'center',
  	valign : 'middle',
  	sortable : true,
  	width : '70px'
  }, 
  {
  	title : '菜单URL',
  	field : 'url',
  	align : 'center',
  	valign : 'middle',
  
  	width : '160px'
  }, 
  {
  	title : '授权标识',//要显示的标题名称
  	field : 'permission',//json串中的key
  	align : 'center',//水平居中
  	valign : 'middle',//垂直居中
  	sortable : false //是否排序
  } ];//格式来自官方demos -->treeGrid(jquery扩展的一个网格树插件)
  ```

  `title` 在thead中显示的内容

  `field`对应后端传递的数据变量名称

  `align`,`valign`,`width`这一列的样式

+ 加载数据

  ```js
  function doGetObjects(){
  	//移除mainContentId位置的数据
  	$("#mainContentId").removeData();
  	var treeTable=new TreeTable(
  				"menuTable",//tableId
  				"menu/doFindObjects",//url	
  				 columns);//表中列的配置
  	//treeTable.setExpandColumn(2);
  	//做表格初始化
  	treeTable.init();	//发起ajax请求(借助ajax函数)
  	
  }
  ```

#### ### treegrid呈现数据 ####

##### treegrid使用方法 #####

前端传递数据使用的是`treegrid`来实现

本项目使用的为JQ中的treegrid

[树网格jquery插件 (maxazan.github.io)](http://maxazan.github.io/jquery-treegrid/)	

<!-- 一直没有好的教程,只能问AI了 -->

treegrid是一个jQuery插件，用于在网格中显示树形结构的数据。下面是使用treegrid插件的一般步骤：

1. 引入treegrid插件的相关文件。通常需要引入jquery.treegrid.extension.js、jquery.treegrid.min.js和tree.table.js这三个文件。

2. 在HTML中创建一个表格，并为其添加一个唯一的id属性，用于标识该表格。

3. 定义表格的列配置。每个列都需要指定标题、字段名和其他属性，用于显示和操作数据。

4. 在JavaScript中，使用TreeTable对象来初始化表格。创建一个TreeTable实例，传入表格的id、数据源的URL和列配置。

5. 调用init()方法发起异步请求获取数据，并将数据填充到表格中。

6. 可选：设置表格的展开列、排序等属性。可以使用setExpandColumn()方法设置展开列，使用其他方法设置排序、分页等属性。

下面是一个简单的示例代码，演示了如何使用treegrid插件：

```html
<table id="menuTable" class="table table-hover">
  <thead>
    <tr>
      <th data-field="selectItem" data-checkbox="true"></th>
      <!-- 其他列配置 -->
    </tr>
  </thead>
  <!-- 表格内容 -->
</table>

<script type="text/javascript" src="bower_components/treegrid/jquery.treegrid.extension.js"></script>
<script type="text/javascript" src="bower_components/treegrid/jquery.treegrid.min.js"></script>
<script type="text/javascript" src="bower_components/treegrid/tree.table.js"></script>
<script type="text/javascript">
  var columns = [
    // 列配置
  ];

  $(function() {
    var treeTable = new TreeTable("menuTable", "menu/doFindObjects", columns);
    treeTable.init();
  });
</script>
```

##### treegrid源码过程分析 #####

在本项目中存在treegrid源码文件,是经过修饰的

位置在scr/main/resource/static/bower_components/treegrid

其中有四个个js文件

1. 首先先是创建`TreeTable`对象

   在`tree.table.js`文件中

   ```js
   (function () {
       var TreeTable = function (tableId, url, columns) {
           this.btInstance = null;					//jquery和bootstrapTreeTable绑定的对象
           this.bstableId = tableId;
           this.url = url;
           this.method = "GET";
           this.columns = columns;
           this.data = {};// ajax的参数
           this.expandColumn = null;// 展开显示的列 
           this.id = 'id';// 选取记录返回的值
           this.code = 'id';// 用于设置父子关系
           this.parentCode = 'parentId';// 用于设置父子关系
           this.expandAll = false;// 是否默认全部展开
           this.toolbarId = tableId + "Toolbar";
           this.height = 430;
       };
   ```

   

