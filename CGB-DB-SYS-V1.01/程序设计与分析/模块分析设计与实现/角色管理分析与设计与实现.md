# 1. 角色管理模块分析

## 1.1 业务设计说明

本模块主要实现的是企业内部角色(岗位)的管理,可以在添加角色时,**为角色分配资源访问权限**,最后将角色再分配给用户

![2023-12-2815:16:20--image10.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/2023-12-2815:16:20--image10.png)

+ 将菜单的管理权限赋予角色，让这个角色可以对数据进行访问和修改

+ 角色和菜单之间的关系是多对多，相同的角色可以管理不同的菜单，相同的菜单也要被不同的角色进行管理

+ 角色和用户之间的关系是多对多，相同的用户和可以不同的角色，相同的角色也是不同的用户

+ 在管理时，我们不仅仅要管理菜单，角色，用户表，也要处理菜单，角色，用户之间的关系表

+ 部门与用户是一对多的关系，用户与日志是一对多的关系

这里要处理7张表，包括部门，用户，日志，角色，菜单，用户与角色的关系表，菜单与角色的关系表

![2023-12-2815:30:03--image13.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/2023-12-2815:30:03--image13.png)

## 1.2 数据库表设计

### 1.2.1 数据表设计

角色数据表:

|字段名          |类型      |约束       |说明|
| ------------  | -------- | -------   | ------------------------------|
|id             |int       |primary    |角色主键                        |
|name           |varchar   |           |角色名称                        |
|note           |varchar   |           |备注                            |
|createdTime    |datetime  |           |创建时间                        |
| modifiedTime  | datetime |           | 修改时间                       |
| createdUser   | varchar  |           | 创建用户                       |
| modifiedUser  | varchar  |           | 修改用户                       |

### 1.2.2 数据关系表设计

菜单与角色数据关系表:

|字段名          |类型       |约束      |说明|
| ------------  | --------  | -------  | ------------------------------|
|id             |int        |primary   |主键                            |
|role_id        |int        |          |角色id                         |
|menu_id        |int        |          |菜单id                         |

用户与角色数据关系表:

|字段名          |类型       |约束      |说明|
| ------------  | --------  | -------  | ------------------------------|
|id             |int        |primary   |主键                            |
|role_id        |int        |          |角色id                         |
|user_id        |int        |          |用户id                         |

# 2. 原型说明

基于用户需求，通过静态页面为用户呈现角色模块的基本需求。

当在主页点击角色管理时，呈现角色列表页面、

![2023-12-2816:14:54--image15.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/2023-12-2816:14:54--image15.png)

在列表页面点击添加按钮时，呈现角色编辑页面

![2023-12-2816:15:11--image17.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/2023-12-2816:15:11--image17.png)

在列表页面点击编辑按钮时，呈现角色编辑页面

![2023-12-2816:15:27--image4.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/2023-12-2816:15:27--image4.png)

# 3. API设计

角色管理业务后台API分层架构及调用关系如图

![2023-12-2816:17:21--image5.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/2023-12-2816:17:21--image5.png)

我们需要管理多个`dao`对象来实现对角色权限的管理

# 4 页面呈现

## 4.1 页面实现时序分析

页面呈现时序图:

<img src="https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/2023-12-2908:51:47--image8.png" alt="2023-12-2908:51:47--image8.png" style="zoom:67%;" />

## 4.2 页面呈现实现

服务端实现：

我们已经拥有了这个万能的方法。这里我们无需添加

```java
@RequestMapping("{module}/{moduleUI}")
public String doModuleUI(@PathVariable String moduleUI) {
    return "sys/"+moduleUI;
}
```

客户端实现：

我们要在主页面中加载`role_list`页面

在`starter.html`中

```js
// 在页面加载时执行，将单击事件注册到`load-role-id`中
$(function(){
    doLoadUI("load-role-id","role/role_list")
})

// 注册单击事件，异步加载`role/role_list`
function doLoadUI(id,url){
    $("#"+id).click(function(){
        $("#mainContentId").load(url);
    });
}
```

# 5. 角色查询功能

## 5.1 角色查询功能分析与设计

### 5.1.1 数据架构分析

角色列表页面加载完成，启动角色数据异步加载操作，本次角色列表页面要以分页形式呈现角色信息，其数据查询时，数据的封装及传递过程

![2023-12-2910:02:29--image14.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/2023-12-2910:02:29--image14.png)

1. 本模块将从数据库查询到的角色数据封装到SysRole对象，一行记录一个SysRole对象。

2. 本模块需要做分页查询，来对查询到的角色进行展示

3. 因为分页查询，需要查询行数，和指定页数的数据

### 5.1.2 时序分析

角色数据分页查询时,其时序分析如图所示:

![2023-12-2910:03:22--image1.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/2023-12-2910:03:22--image1.png)

1. 前端获取数据进入服务端

2. 要获取行数和页面数据

## 5.2 角色查询功能实现

### 5.2.1 Entity实体类

将数据封装到`SysRole`实体类中

```java
public class SysRole implements Serializable{
    private static final long serialVersionUID = 8676320356852063050L;
    private Integer id;
    private String name;
    private String note;
    private LocalDate createdTime;
    private LocalDate modifiedTime;
    private String createdUser;
    private String modifiedUser;
}
```

### 5.2.2 持久层实现

#### mapper 接口设计

这里查询方法可以设置一个参数`name`可以进行对角色名称的模糊查询

```java
Integer getRowCount(String name);

List<SysRole> findPageObject(String name,Integer jump,Integer num);
```

#### ####SQL 语句设计

使用`sql`标签来实现SQL中的共性操作

```xml
<!-- SQL共性操 -->
<sql id="queryWhereId">
    <where>
        <if test="name != null and name !=''">
            name like concat("%",#{name},"%")
        </if>
    </where>
</sql>
```

查询指定角色名的总数目

```xml
<select id="getRowCount" resultType="int">
    select count(*) from sys_roles
    <include refid="queryWhereId" />
</select>
```

 查询指定角色名的数据

```xml
<select id="findPageObject" resultType="com.cy.pj.sys.entity.SysLog">
    select id, username, operation, `method`, params, `time`, ip, createdTime from sys_logs
    <where>
        <if test="username!=null and username!=''">
            username like concat("%",#{username},"%")
        </if>
    </where>
    limit #{startIndex},#{pageSize}
</select>
```

### 5.2.3业务层实现

service接口设计

```java
public interface SysRoleService {
    Integer pageSize = 2;
    PageObject<SysRole> findPageObject(String name, Long pageCurrent);
}
```

service 实现

```java
public class SysRoleServiceImpl implements SysRoleService {

    @Autowired
    private SysRoleDao sysRoleDao;

    @Override
    public PageObject<SysRole> findPageObject(String name, Long pageCurrent) {
        
        // 验证参数是否正确
        // pageCurrent是否正确
        if(pageCurrent == null || pageCurrent<1)
            throw new IllegalArgumentException("当前页码值无效");
        
        // 对总查询记录进行校验
        Long rowCount = sysRoleDao.getRowCount(name);
        if(rowCount <=0 )
            throw new ServiceException("没有找到对应记录");

        // 获取页面数据
        Long startIndex = (pageCurrent - 1 ) * pageSize;
        List<SysRole> sysRoles = sysRoleDao.findPageObject(name, startIndex, pageSize);
        return new PageObject<SysRole>(pageCurrent,pageSize,rowCount,sysRoles);
    }
}
```

### 5.2.4控制层实现

```java
@RequestMapping("doFindPageObjects")
public JsonResult doFindPageObjects(String name, Long pageCurrent) {
    return new JsonResult(sysRoleService.findPageObject(name, pageCurrent));
}
```

# 6. 角色删除功能

## 6.1 角色功能查询功能分析与设计

时序分析

![2024-1-308:57:55--image12.png](https://gitee.com/teamsea/tuchuang/raw/master/tuchuang/2024-1-308:57:55--image12.png)

## 5.2 角色删除功能实现

